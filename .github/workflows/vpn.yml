name: Tailscale-VPN
on:
  workflow_dispatch:

jobs:
  tailscale:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install Tailscale
        run: curl -fsSL https://tailscale.com/install.sh | sh

      - name: Connect as exit node (protected)
        run: |
          # Bring up Tailscale as exit node
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname="vpn-${{ github.run_id }}" \
            --advertise-exit-node

          # Capture IP
          ip=$(tailscale ip -4)
          echo "TAILSCALE_IP=$ip" >> $GITHUB_ENV

          # Basic protection: allow only Tailscale interface traffic
          sudo ufw default deny incoming
          sudo ufw default deny outgoing
          sudo ufw allow in on tailscale0
          sudo ufw allow out on tailscale0
          sudo ufw --force enable

      - name: Keep alive
        run: |
          echo "Exit node address: $TAILSCALE_IP"
          while true; do echo "[$(date)] Active"; sleep 300; done
